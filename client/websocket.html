<!DOCTYPE html>

<meta charset="utf-8"/>

<title>WebSocket Test</title>
<script src="static/js/fabric.js"></script>
<script language="javascript" type="text/javascript">


    function init() {
        document.myform.url.value = "ws://localhost:8000/"
        document.myform.inputtext.value = "Hello World!"
        document.myform.disconnectButton.disabled = true;

        init_battlefield()
    }

    function doConnect() {
        websocket = new WebSocket(document.myform.url.value);
        websocket.onopen = function (evt) {
            onOpen(evt)
        };
        websocket.onclose = function (evt) {
            onClose(evt)
        };
        websocket.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket.onerror = function (evt) {
            onError(evt)
        };
    }

    function onOpen(evt) {
        writeToScreen("connected\n");
        document.myform.connectButton.disabled = true;
        document.myform.disconnectButton.disabled = false;
    }

    function onClose(evt) {
        writeToScreen("disconnected\n");
        document.myform.connectButton.disabled = false;
        document.myform.disconnectButton.disabled = true;
    }

    function onMessage(evt) {
        var data = decoder(evt.data)
        writeToScreen("response: " + data + '\n');

        //
        updateTanks(data)
    }

    function onError(evt) {
        writeToScreen('error: ' + evt.data + '\n');

        websocket.close();

        document.myform.connectButton.disabled = false;
        document.myform.disconnectButton.disabled = true;

    }

    function doSend(message) {
        writeToScreen("sent: " + message + '\n');
        websocket.send(message);
    }

    function writeToScreen(message) {
        document.myform.outputtext.value += message
        document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;

    }

    window.addEventListener("load", init, false);


    function sendText() {
        doSend(document.myform.inputtext.value);
    }

    function clearText() {
        document.myform.outputtext.value = "";
    }

    function doDisconnect() {
        websocket.close();
    }

    function init_battlefield() {

        // create a wrapper around native canvas element (with id="c")
        var canvas = new fabric.Canvas('c');
        window.battleField = canvas
        window.tanks = []
    }

    function updateTanks(tanks) {
        for (i in tanks) {
            updateTank(tanks[i])
        }
    }

    function updateTank(tank) {
        console.log(tank)
        var left = Number(tank.x)
        var top = Number(tank.y)
        var width = Number(tank.width)
        var height = Number(tank.height)

        // "add" rectangle onto canvas
        if (window.tanks.length) {
            for (i in window.tanks) {
                if (window.tanks[i].name == tank.name) {
                    //移动
                    console.log('移动')
                    window.tanks[i].set({'left': left, 'top': top});
                    window.battleField.renderAll()
                    return
                }
            }
        }

        console.log('添加')
        var rect = new fabric.Rect({
            left: left,
            top: top,
            fill: 'red',
            width: width,
            height: height
        });
        rect.name = tank.name
        window.battleField.add(rect);
        window.tanks.push(rect)


    }

    /*websocket消息解码器
    raw消息如下：
    width:20|height:20|x:50|y:50|name:t1|life:100|oil:100|weapon:0|status:3|direction:2|velocity:5;
    width:20|height:20|x:300|y:50|name:t2|life:100|oil:100|weapon:0|status:3|direction:3|velocity:5
     */
    function decoder(str) {
        var target = []
        var groups = str.split(';')
        for (i = 0; i < groups.length; i++) {
            var list = groups[i].split('|')
            var row = {}
            for (j = 0; j < list.length; j++) {
                var pair = list[j].split(':')
                row[pair[0]] = pair[1]
            }
            target.push(row)
        }
        return target
    }


</script>

<div id="output"></div>

<form name="myform">
    <p>
        <textarea name="outputtext" rows="20" cols="50"></textarea>
    </p>
    <p>
        <textarea name="inputtext" cols="50"></textarea>
    </p>
    <p>
        <textarea name="url" cols="50"></textarea>
    </p>
    <p>
        <input type="button" name=sendButton value="Send" onClick="sendText();">
        <input type="button" name=clearButton value="Clear" onClick="clearText();">
        <input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
        <input type="button" name=connectButton value="Connect" onClick="doConnect();">
    </p>
    <p>
        <canvas id='c' width="600" height="400"></canvas>
    </p>

</form>
</html> 

