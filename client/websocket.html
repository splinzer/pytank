<!DOCTYPE html>

<meta charset="utf-8"/>

<title>WebSocket Test</title>
<script src="static/js/fabric.js"></script>
<script language="javascript" type="text/javascript">

    var STATUS_READY = 1;
    var STATUS_DEAD = 2;
    var STATUS_STOP = 3;
    var STATUS_MOVING = 4;

    var MAX_VELOCITY = 5;

    var DIRECTION_UP = 1;
    var DIRECTION_DOWN = 2;
    var DIRECTION_LEFT = 3;
    var DIRECTION_RIGHT = 4;

    function init() {
        document.myform.disconnectButton.disabled = true;
        //自动连接websocket服务器
        doConnect();
        //初始化战场
        init_battlefield();
    }

    function doConnect() {
        websocket = new WebSocket("ws://localhost:8000/");
        websocket.onopen = function (evt) {
            onOpen(evt);
        };
        websocket.onclose = function (evt) {
            onClose(evt);
        };
        websocket.onmessage = function (evt) {
            onMessage(evt);
        };
        websocket.onerror = function (evt) {
            onError(evt);
        };
    }

    function onOpen(evt) {
        writeToScreen("connected\n");
        document.myform.connectButton.disabled = true;
        document.myform.disconnectButton.disabled = false;
    }

    function onClose(evt) {
        writeToScreen("disconnected\n");
        document.myform.connectButton.disabled = false;
        document.myform.disconnectButton.disabled = true;
    }

    function onMessage(evt) {
        writeToScreen("response: " + evt.data + '\n');
        var data = decoder(evt.data);
        //更新战场坦克
        updateBattle(data)
    }

    function onError(evt) {
        writeToScreen('error: ' + evt.data + '\n');

        websocket.close();

        document.myform.connectButton.disabled = false;
        document.myform.disconnectButton.disabled = true;

    }

    // function doSend(message) {
    //     writeToScreen("sent: " + message + '\n');
    //     websocket.send(message);
    // }

    function writeToScreen(message) {
        document.myform.outputtext.value += message;
        document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;

    }

    window.addEventListener("load", init, false);


    // function sendText() {
    //     doSend(document.myform.inputtext.value);
    // }

    function clearText() {
        document.myform.outputtext.value = "";
    }

    function doDisconnect() {
        websocket.close();
    }

    function init_battlefield() {

        // create a wrapper around native canvas element (with id="c")
        var canvas = new fabric.Canvas('c');
        window.battleField = canvas;
        window.rectObjects = []
    }

    // 检测坦克是否已经存在于战场中,存在则返回该对象，否则返回false
    function exists(rectObject) {
        // var exclude = ['barrier'];
        if (window.rectObjects.length) {
            for (i in window.rectObjects) {
                if (window.rectObjects[i].ro_id == rectObject.id) {
                    // return true;
                    console.log('要删除的对象',window.rectObjects[i]);
                    return window.rectObjects[i];
                }
            }
        }
        return false

    }

    function updateBattle(dataList) {
        for (n in dataList) {
            var rectObject = dataList[n];
            console.log(rectObject.name, rectObject.x, rectObject.y);
            var left = Number(rectObject.x);
            var top = Number(rectObject.y);
            var width = Number(rectObject.width);
            var height = Number(rectObject.height);
            var direction = Number(rectObject.direction);
            var angle = 0;
            switch (direction){
                case 1:
                    angle = -90;
                    break;
                case 2:
                    angle = 90;
                    break;
                case 3:
                    angle = 180;
                    break;
            }

            target_obj = exists(rectObject);
            if (target_obj) {
                console.log('更新');
                // 判断目标是否已经死亡
                if(rectObject.status == STATUS_DEAD){
                    window.battleField.remove(target_obj);
                    window.battleField.requestRenderAll();
                }
                window.rectObjects[i].set({'left': left, 'top': top ,'angle': angle});
                // window.battleField.renderAll()
                window.battleField.requestRenderAll()
            }
            else {

                var canvas = new fabric.Canvas('c');
                var imgElement = document.getElementById('my-image');
                var imgInstance = new fabric.Image(imgElement, {
                  left: left,
                  top: top,
                  angle: angle,
                });
                imgInstance.ro_id = rectObject.id
                imgInstance.ro_type = rectObject.type
                window.battleField.add(imgInstance);
                window.rectObjects.push(imgInstance)
                /*
                console.log('添加')
                var rect = new fabric.Rect({
                    left: left,
                    top: top,
                    fill: 'red',
                    width: width,
                    height: height
                });
                rect.ro_id = rectObject.id
                rect.ro_type = rectObject.type
                window.battleField.add(rect);
                window.rectObjects.push(rect)*/
            }

        }
    }


    /*websocket消息解码器
    raw消息如下：
    id:t1|width:20|height:20|x:95|y:50|direction:3|velocity:5|life:100|oil:100|weapon:0|status:3;
    id:t2|width:20|height:20|x:255|y:50|direction:2|velocity:5|life:100|oil:100|weapon:0|status:3
     */
    function decoder(str) {
        var target = []
        var groups = str.split(';')
        for (i = 0; i < groups.length; i++) {
            var list = groups[i].split('|')
            var row = {}
            for (j = 0; j < list.length; j++) {
                var pair = list[j].split(':')
                row[pair[0]] = pair[1]
            }
            target.push(row)
        }
        return target
    }


</script>
<div style="width:800px;height:600px;border:1px solid gray;margin:4px auto">

    <canvas id='c' width="800px" height="600px" ></canvas>

</div>
<div style="margin:4px auto;width:100%;">

    <div id="output"></div>

    <form name="myform">
        <p>
            <textarea name="outputtext" style="width:100%;height:280px;font-size: 10px;"></textarea>
        </p>
        <!--<p>-->
        <!--<textarea name="inputtext" cols="50"></textarea>-->
        <!--</p>-->
        <!--<p>-->
        <!--<textarea name="url" cols="50"></textarea>-->
        <!--</p>-->
        <p>
            <!--<input type="button" name=sendButton value="Send" onClick="sendText();">-->
            <input type="button" name=clearButton value="Clear" onClick="clearText();">
            <input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
            <input type="button" name=connectButton value="Connect" onClick="doConnect();">
        </p>


    </form>
</div>
<img src="static/imgs/tank0.png" id="my-image" style="display: none;">

</html>

